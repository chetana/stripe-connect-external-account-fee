<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stripe Connect Demo (Spring)</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
<header>
  <h1>Stripe Connect Demo (Spring)</h1>
  <p class="subtitle">Onboarding des comptes et paiements (Payment Intents) avec destination charge.</p>
</header>
<main>
  <section class="card">
    <h2>Gérer les comptes connectés</h2>
    <div style="margin-bottom: 1rem;">
      <button id="btn-create-account">Create connected account</button>
    </div>
    <div style="margin-bottom: 1rem;">
      <input id="existing-account-id" placeholder="acct_... (compte existant)" style="margin-right: 0.5rem; padding: 0.5rem;" />
      <button id="btn-add-existing">Ajouter compte existant</button>
    </div>
    <div id="accounts" class="list"></div>
  </section>

  <section class="card">
    <h2>Créer un paiement (Payment Intent)</h2>
    <form id="pi-form">
      <div class="row">
        <label>Montant (cents)</label>
        <input name="amount" type="number" min="1" placeholder="2000" required />
      </div>
      <div class="row">
        <label>Devise</label>
        <input name="currency" value="eur" required />
      </div>
      <div class="row">
        <label>Compte connecté (acct_...)</label>
        <input name="connected_account_id" placeholder="acct_..." required />
      </div>
      <div class="row">
        <label>Frais d'application (cents, optionnel)</label>
        <input name="application_fee_amount" type="number" min="0" placeholder="200" />
      </div>
      <div class="row">
        <label>Order ID (optionnel)</label>
        <input name="order_id" placeholder="ORD-123" />
      </div>
      <button type="submit">Aller au paiement</button>
    </form>
  </section>
</main>
<script>
  async function refreshState() {
    const res = await fetch('/api/state');
    const data = await res.json();

    const list = document.getElementById('accounts');
    list.innerHTML = '';

    data.accounts.forEach(a => {
      const div = document.createElement('div');
      div.className = 'rowish';
      div.innerHTML = `
        <code>${a.id}</code>
        <span>Charges: <strong>${a.charges_enabled ? 'enabled' : 'disabled'}</strong> · Payouts: <strong>${a.payouts_enabled ? 'enabled' : 'disabled'}</strong></span>
        <button data-id="${a.id}" class="btn-onboard">Onboard to collect payments</button>
      `;
      list.appendChild(div);
    });

    document.querySelectorAll('.btn-onboard').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const r = await fetch(`/accounts/${id}/onboard`, { method: 'POST' });
        const j = await r.json();
        if (j.url) window.location = j.url; else alert(j.error || 'Failed to create account link');
      };
    });

    document.querySelectorAll('.btn-buy').forEach(btn => {
      btn.onclick = async (e) => {
        const card = e.target.closest('.p-card');
        const qty = card.querySelector('.qty').value || 1;
        const r = await fetch('/checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ product_id: btn.getAttribute('data-id'), quantity: qty })});
        const j = await r.json();
        if (j.url) window.location = j.url; else alert(j.error || 'Failed to create checkout session');
      };
    });
  }

  document.getElementById('btn-create-account').onclick = async () => {
    const r = await fetch('/accounts', { method: 'POST' });
    const j = await r.json();
    if (j.error) alert(j.error);
    await refreshState();
  };

  document.getElementById('btn-add-existing').onclick = async () => {
    const accountId = document.getElementById('existing-account-id').value.trim();
    if (!accountId) {
      alert('Veuillez saisir un ID de compte (acct_...)');
      return;
    }
    if (!accountId.startsWith('acct_')) {
      alert('L\'ID du compte doit commencer par "acct_"');
      return;
    }
    
    try {
      const r = await fetch(`/accounts/${accountId}/verify`, { method: 'POST' });
      const j = await r.json();
      if (j.error) {
        alert(`Erreur: ${j.error}`);
      } else {
        alert(`Compte ajouté avec succès: ${accountId}`);
        document.getElementById('existing-account-id').value = '';
        await refreshState();
      }
    } catch (e) {
      alert(`Erreur lors de la vérification du compte: ${e.message}`);
    }
  };

  document.getElementById('pi-form').onsubmit = async (e) => {
    e.preventDefault();
    const form = e.target;
    const p = Object.fromEntries(new FormData(form).entries());
    // Redirige vers /pay avec les paramètres saisis
    const qs = new URLSearchParams(p).toString();
    window.location = `/pay?${qs}`;
  };

  refreshState();
</script>
</body>
</html>