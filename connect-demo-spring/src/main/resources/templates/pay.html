<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pay — Payment Intents (Connect)</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 2rem; }
    .row { margin-bottom: 1rem; }
    label { display: block; font-weight: 600; margin-bottom: .25rem; }
    input, select, button { padding: .5rem .6rem; font-size: 1rem; }
    #payment-element { margin: 1rem 0; }
    .log { white-space: pre-wrap; background: #f6f8fa; padding: .75rem; border-radius: 6px; font-size: .9rem; }
  </style>
</head>
<body>
  <h1>Payment Intents — Destination charge (Connect)</h1>

  <div class="row">
    <label for="account">Connected account id (acct_...)</label>
    <input id="account" placeholder="acct_..." th:value="${connected_account_id}" />
  </div>
  <div class="row">
    <label for="amount">Amount (cents)</label>
    <input id="amount" type="number" th:value="${amount}" />
  </div>
  <div class="row">
    <label for="currency">Currency</label>
    <input id="currency" th:value="${currency}" />
  </div>
  <div class="row">
    <label for="fee">Application fee amount (cents, optional)</label>
    <input id="fee" type="number" th:value="${application_fee_amount}" />
  </div>
  <div class="row">
    <label for="order">Order ID (metadata, optional)</label>
    <input id="order" placeholder="ORD-123" th:value="${order_id}" />
  </div>

  <div id="payment-element"></div>
  <button id="create">Créer PaymentIntent</button>
  <button id="pay" style="display: none;">Confirmer le paiement</button>

  <h3>Console</h3>
  <div id="log" class="log"></div>

  <script th:inline="javascript">
    const PUBLISHABLE_KEY = /*[[${publishableKey}]]*/ "";

    const log = (msg) => {
      const el = document.getElementById('log');
      el.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + "\n";
    };

    const postJSON = async (url, body) => {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const json = await res.json();
      if (!res.ok || json.error) throw new Error(json.error || res.statusText);
      return json;
    };

    let stripe, elements, paymentElement;

    document.getElementById('create').onclick = async () => {
      try {
        log('Creating PaymentIntent...');
        if (!PUBLISHABLE_KEY || PUBLISHABLE_KEY.includes('_PUT_')) {
          throw new Error('Missing publishable key in config (stripe.publishableKey)');
        }
        stripe = Stripe(PUBLISHABLE_KEY);

        // Gather inputs
        const account = document.getElementById('account').value.trim();
        const amount = parseInt(document.getElementById('amount').value, 10);
        const currency = document.getElementById('currency').value.trim();
        const fee = document.getElementById('fee').value ? parseInt(document.getElementById('fee').value, 10) : null;
        const order = document.getElementById('order').value.trim() || null;

        // Create PaymentIntent on server
        const pi = await postJSON('/payments', {
          amount, currency, connected_account_id: account,
          application_fee_amount: fee, order_id: order
        });
        log(['PaymentIntent created', pi]);

        // Mount Payment Element
        elements = stripe.elements({ clientSecret: pi.client_secret });
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');

        // Show pay button and hide create button
        document.getElementById('create').style.display = 'none';
        document.getElementById('pay').style.display = 'inline-block';
        
        log('Veuillez remplir les informations de paiement et cliquer sur "Confirmer le paiement"');
      } catch (e) {
        log(['Error', e.message || e.toString()]);
        alert(e.message || e.toString());
      }
    };

    document.getElementById('pay').onclick = async () => {
      try {
        log('Confirming payment...');
        
        // Confirm payment
        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: { return_url: window.location.origin + '/success' }
        });
        if (error) {
          log(['Payment failed', error.message]);
          alert('Erreur de paiement: ' + error.message);
        } else {
          log('Payment confirmation initiated...');
        }
      } catch (e) {
        log(['Error', e.message || e.toString()]);
        alert(e.message || e.toString());
      }
    };
  </script>
</body>
</html>